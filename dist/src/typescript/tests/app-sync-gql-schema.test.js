"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.prepModule = void 0;
const aws_appsync_1 = require("@aws-cdk/aws-appsync");
const core_1 = require("@aws-cdk/core");
const constants_1 = require("../../constants");
jest.mock("graphql-transformer-core");
jest.mock("../utils", () => {
    const actual = jest.requireActual("../utils");
    return Object.assign(Object.assign({}, actual), { readFileSync: jest.fn(), createConstruct: jest.fn() });
});
// this is an experimental function to enable mocking within the same file as the invoked function
const prepModule = (name) => {
    jest.mock(name);
    const mock = jest.requireMock(name);
    const underTest = jest.requireActual(name);
    beforeEach(() => {
        jest.resetAllMocks();
    });
    return {
        mock,
        underTest,
    };
};
exports.prepModule = prepModule;
describe.skip("app-syng-gql-schema-stack", () => {
    const { mock, underTest } = exports.prepModule("../app-sync-gql-schema");
    describe("getSchemaText", () => {
        const { readFileSync } = require("../utils");
        beforeEach(() => {
            readFileSync.mockClear();
        });
        it("should fail if no schema is passed in", () => {
            expect(() => underTest.getSchemaText({})).toThrowError(constants_1.NO_SCHEMA_ERROR_MESSAGE);
        });
        it("should read a schema from file", () => {
            const schemaFile = "/path/to/schema/file";
            const expected = "expected value";
            readFileSync.mockReturnValue(expected);
            const actual = underTest.getSchemaText({ schemaFile });
            expect(actual).toEqual(expected);
            expect(readFileSync).toHaveBeenCalledWith(schemaFile, "utf8");
        });
        it("should return a schema from props", () => {
            const schemaText = "my schema text";
            const actual = underTest.getSchemaText({ schemaText });
            expect(actual).toEqual(schemaText);
            expect(readFileSync).not.toHaveBeenCalled();
        });
    });
    describe("getProviders", () => {
        it("should get default providers without injected providers", () => {
            const actual = underTest.getProviders({});
            expect(actual).toEqual(underTest.defaultDatasourceProviders);
        });
        it("should get default providers with injected providers", () => {
            const providers = [
                {
                    getTransformer: jest.fn(),
                    createResources: jest.fn(),
                },
            ];
            const actual = underTest.getProviders({
                datasourceProviders: providers,
            });
            const expected = [...underTest.defaultDatasourceProviders, ...providers];
            expect(actual).toEqual(expected);
        });
    });
    describe("createResources", () => {
        it("should create resources from ", () => {
            const scope = "scope";
            const cfSchema = "cfSchema";
            const props = "props";
            const api = "api";
            const providers = [
                { createResources: jest.fn().mockReturnValue({ stacks: { one: 1 } }) },
                { createResources: jest.fn().mockReturnValue({ stacks: { two: 2 } }) },
                {
                    createResources: jest.fn().mockReturnValue({ stacks: { three: 3 } }),
                },
            ];
            const expected = {
                stacks: {
                    one: 1,
                    two: 2,
                    three: 3,
                },
            };
            const actual = underTest.createResources(scope, props, api, providers, cfSchema);
            expect(actual).toEqual(expected);
        });
    });
    describe("getCfSchema", () => {
        it("should turn text into ", () => {
            const schemaText = "schema text";
            const props = {
                prop1: "prop 1",
            };
            const providers = [
                { getTransformer: () => ["provider 1"] },
                { getTransformer: () => ["provider 2"] },
            ];
            const transformers = { transformers: ["provider 1", "provider 2"] };
            const expected = "expected";
            const { GraphQLTransform } = jest.requireMock("graphql-transformer-core");
            const transform = jest.fn().mockReturnValue(expected);
            GraphQLTransform.mockImplementation(() => ({
                transform,
            }));
            mock.getSchemaText.mockReturnValue(schemaText);
            const actual = underTest.getCfSchema(props, providers);
            expect(actual).toEqual(expected);
            expect(GraphQLTransform).toHaveBeenCalledWith(transformers);
            expect(transform).toHaveBeenCalledWith(schemaText);
        });
    });
    describe("createApi", () => {
        it("should create an CDK GraphQL API", () => {
            const { createConstruct } = jest.requireMock("../utils");
            const name = "graphql-api";
            const resourceName = "graphql-api";
            const scope = { scope: "scope" };
            const schema = "schema";
            const props = { name, schema };
            const expected = "expected";
            createConstruct.mockReturnValue(expected);
            const actual = underTest.createApi(scope, schema);
            expect(actual).toEqual(expected);
            expect(createConstruct).toHaveBeenCalledWith(scope, props, aws_appsync_1.GraphqlApi, "graphql-api");
        });
    });
    describe("AppSyncGqlSchema", () => {
        it("should create a new construct", () => {
            const props = {
                environment: {
                    ENV_VAR: "env var"
                },
                context: "context",
                prefix: "prefix",
                schemaFile: "schemaFile",
                schemaText: "schemaText",
                defaultsDirectory: "string",
                overridesDirectory: "string",
                defaults: "defaults",
                overrides: "overrides",
                datasourceProviders: "datasourceProviders"
            };
            const scope = new core_1.App({});
            const name = "providers";
            const providers = "providers";
            const cfSchema = "cfSchema";
            mock.getProviders.mockReturnValue(providers);
            mock.getCfSchema.mockReturnValue(cfSchema);
            const actual = new underTest.AppSyncGqlSchema(scope, name, props);
            expect(mock.getProviders).toHaveBeenCalledWith(props);
            expect(mock.getCfSchema).toHaveBeenCalledWith(props, providers);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLXN5bmMtZ3FsLXNjaGVtYS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3R5cGVzY3JpcHQvdGVzdHMvYXBwLXN5bmMtZ3FsLXNjaGVtYS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHNEQUFrRDtBQUNsRCx3Q0FBK0M7QUFDL0MsK0NBQTBEO0FBRzFELElBQUksQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUN0QyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7SUFDMUIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUM5Qyx1Q0FDSSxNQUFNLEtBQ1QsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFDdkIsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFDekI7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILGtHQUFrRztBQUMzRixNQUFNLFVBQVUsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFO0lBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdEIsQ0FBQyxDQUFDLENBQUM7SUFDSCxPQUFPO1FBQ04sSUFBSTtRQUNKLFNBQVM7S0FDVCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBWFcsUUFBQSxVQUFVLGNBV3JCO0FBRUYsUUFBUSxDQUFDLElBQUksQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUU7SUFDL0MsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFT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SUFBSSxVQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDMUIsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDO1lBQ3pCLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQztZQUM5QixNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUM7WUFFNUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDN0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDM0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxTQUFTLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNsRSxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3RELE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsb0JBQW9CLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ2pFLENBQUMsQ0FBQyxDQUFBO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdyYXBocWxBcGkgfSBmcm9tIFwiQGF3cy1jZGsvYXdzLWFwcHN5bmNcIjtcbmltcG9ydCB7IEFwcCwgQ29uc3RydWN0IH0gZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCB7IE5PX1NDSEVNQV9FUlJPUl9NRVNTQUdFIH0gZnJvbSBcIi4uLy4uL2NvbnN0YW50c1wiO1xuaW1wb3J0IHsgSV9EYXRhc291cmNlUHJvdmlkZXIgfSBmcm9tIFwiLi4vaW50ZXJmYWNlc1wiO1xuXG5qZXN0Lm1vY2soXCJncmFwaHFsLXRyYW5zZm9ybWVyLWNvcmVcIik7XG5qZXN0Lm1vY2soXCIuLi91dGlsc1wiLCAoKSA9PiB7XG5cdGNvbnN0IGFjdHVhbCA9IGplc3QucmVxdWlyZUFjdHVhbChcIi4uL3V0aWxzXCIpO1xuXHRyZXR1cm4ge1xuXHRcdC4uLmFjdHVhbCxcblx0XHRyZWFkRmlsZVN5bmM6IGplc3QuZm4oKSxcblx0XHRjcmVhdGVDb25zdHJ1Y3Q6IGplc3QuZm4oKSxcblx0fTtcbn0pO1xuXG4vLyB0aGlzIGlzIGFuIGV4cGVyaW1lbnRhbCBmdW5jdGlvbiB0byBlbmFibGUgbW9ja2luZyB3aXRoaW4gdGhlIHNhbWUgZmlsZSBhcyB0aGUgaW52b2tlZCBmdW5jdGlvblxuZXhwb3J0IGNvbnN0IHByZXBNb2R1bGUgPSAobmFtZSkgPT4ge1xuXHRqZXN0Lm1vY2sobmFtZSk7XG5cdGNvbnN0IG1vY2sgPSBqZXN0LnJlcXVpcmVNb2NrKG5hbWUpO1xuXHRjb25zdCB1bmRlclRlc3QgPSBqZXN0LnJlcXVpcmVBY3R1YWwobmFtZSk7XG5cdGJlZm9yZUVhY2goKCkgPT4ge1xuXHRcdGplc3QucmVzZXRBbGxNb2NrcygpO1xuXHR9KTtcblx0cmV0dXJuIHtcblx0XHRtb2NrLFxuXHRcdHVuZGVyVGVzdCxcblx0fTtcbn07XG5cbmRlc2NyaWJlLnNraXAoXCJhcHAtc3luZy1ncWwtc2NoZW1hLXN0YWNrXCIsICgpID0+IHtcblx0Y29uc3QgeyBtb2NrLCB1bmRlclRlc3QgfSA9IHByZXBNb2R1bGUoXCIuLi9hcHAtc3luYy1ncWwtc2NoZW1hXCIpO1xuXHRkZXNjcmliZShcImdldFNjaGVtYVRleHRcIiwgKCkgPT4ge1xuXHRcdGNvbnN0IHsgcmVhZEZpbGVTeW5jIH0gPSByZXF1aXJlKFwiLi4vdXRpbHNcIik7XG5cdFx0YmVmb3JlRWFjaCgoKSA9PiB7XG5cdFx0XHRyZWFkRmlsZVN5bmMubW9ja0NsZWFyKCk7XG5cdFx0fSk7XG5cdFx0aXQoXCJzaG91bGQgZmFpbCBpZiBubyBzY2hlbWEgaXMgcGFzc2VkIGluXCIsICgpID0+IHtcblx0XHRcdGV4cGVjdCgoKSA9PiB1bmRlclRlc3QuZ2V0U2NoZW1hVGV4dCh7fSkpLnRvVGhyb3dFcnJvcihcblx0XHRcdFx0Tk9fU0NIRU1BX0VSUk9SX01FU1NBR0UsXG5cdFx0XHQpO1xuXHRcdH0pO1xuXHRcdGl0KFwic2hvdWxkIHJlYWQgYSBzY2hlbWEgZnJvbSBmaWxlXCIsICgpID0+IHtcblx0XHRcdGNvbnN0IHNjaGVtYUZpbGUgPSBcIi9wYXRoL3RvL3NjaGVtYS9maWxlXCI7XG5cdFx0XHRjb25zdCBleHBlY3RlZCA9IFwiZXhwZWN0ZWQgdmFsdWVcIjtcblx0XHRcdHJlYWRGaWxlU3luYy5tb2NrUmV0dXJuVmFsdWUoZXhwZWN0ZWQpO1xuXHRcdFx0Y29uc3QgYWN0dWFsID0gdW5kZXJUZXN0LmdldFNjaGVtYVRleHQoeyBzY2hlbWFGaWxlIH0pO1xuXHRcdFx0ZXhwZWN0KGFjdHVhbCkudG9FcXVhbChleHBlY3RlZCk7XG5cdFx0XHRleHBlY3QocmVhZEZpbGVTeW5jKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChzY2hlbWFGaWxlLCBcInV0ZjhcIik7XG5cdFx0fSk7XG5cdFx0aXQoXCJzaG91bGQgcmV0dXJuIGEgc2NoZW1hIGZyb20gcHJvcHNcIiwgKCkgPT4ge1xuXHRcdFx0Y29uc3Qgc2NoZW1hVGV4dCA9IFwibXkgc2NoZW1hIHRleHRcIjtcblx0XHRcdGNvbnN0IGFjdHVhbCA9IHVuZGVyVGVzdC5nZXRTY2hlbWFUZXh0KHsgc2NoZW1hVGV4dCB9KTtcblx0XHRcdGV4cGVjdChhY3R1YWwpLnRvRXF1YWwoc2NoZW1hVGV4dCk7XG5cdFx0XHRleHBlY3QocmVhZEZpbGVTeW5jKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuXHRcdH0pO1xuXHR9KTtcblx0ZGVzY3JpYmUoXCJnZXRQcm92aWRlcnNcIiwgKCkgPT4ge1xuXHRcdGl0KFwic2hvdWxkIGdldCBkZWZhdWx0IHByb3ZpZGVycyB3aXRob3V0IGluamVjdGVkIHByb3ZpZGVyc1wiLCAoKSA9PiB7XG5cdFx0XHRjb25zdCBhY3R1YWwgPSB1bmRlclRlc3QuZ2V0UHJvdmlkZXJzKHt9KTtcblx0XHRcdGV4cGVjdChhY3R1YWwpLnRvRXF1YWwodW5kZXJUZXN0LmRlZmF1bHREYXRhc291cmNlUHJvdmlkZXJzKTtcblx0XHR9KTtcblx0XHRpdChcInNob3VsZCBnZXQgZGVmYXVsdCBwcm92aWRlcnMgd2l0aCBpbmplY3RlZCBwcm92aWRlcnNcIiwgKCkgPT4ge1xuXHRcdFx0Y29uc3QgcHJvdmlkZXJzID0gW1xuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Z2V0VHJhbnNmb3JtZXI6IGplc3QuZm4oKSxcblx0XHRcdFx0XHRjcmVhdGVSZXNvdXJjZXM6IGplc3QuZm4oKSxcblx0XHRcdFx0fSxcblx0XHRcdF07XG5cdFx0XHRjb25zdCBhY3R1YWwgPSB1bmRlclRlc3QuZ2V0UHJvdmlkZXJzKHtcblx0XHRcdFx0ZGF0YXNvdXJjZVByb3ZpZGVyczogcHJvdmlkZXJzLFxuXHRcdFx0fSk7XG5cdFx0XHRjb25zdCBleHBlY3RlZCA9IFsuLi51bmRlclRlc3QuZGVmYXVsdERhdGFzb3VyY2VQcm92aWRlcnMsIC4uLnByb3ZpZGVyc107XG5cdFx0XHRleHBlY3QoYWN0dWFsKS50b0VxdWFsKGV4cGVjdGVkKTtcblx0XHR9KTtcblx0fSk7XG5cdGRlc2NyaWJlKFwiY3JlYXRlUmVzb3VyY2VzXCIsICgpID0+IHtcblx0XHRpdChcInNob3VsZCBjcmVhdGUgcmVzb3VyY2VzIGZyb20gXCIsICgpID0+IHtcblx0XHRcdGNvbnN0IHNjb3BlID0gXCJzY29wZVwiO1xuXHRcdFx0Y29uc3QgY2ZTY2hlbWEgPSBcImNmU2NoZW1hXCI7XG5cdFx0XHRjb25zdCBwcm9wcyA9IFwicHJvcHNcIjtcblx0XHRcdGNvbnN0IGFwaSA9IFwiYXBpXCI7XG5cdFx0XHRjb25zdCBwcm92aWRlcnMgPSBbXG5cdFx0XHRcdHsgY3JlYXRlUmVzb3VyY2VzOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgc3RhY2tzOiB7IG9uZTogMSB9IH0pIH0sXG5cdFx0XHRcdHsgY3JlYXRlUmVzb3VyY2VzOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHsgc3RhY2tzOiB7IHR3bzogMiB9IH0pIH0sXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRjcmVhdGVSZXNvdXJjZXM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBzdGFja3M6IHsgdGhyZWU6IDMgfSB9KSxcblx0XHRcdFx0fSxcblx0XHRcdF07XG5cdFx0XHRjb25zdCBleHBlY3RlZCA9IHtcblx0XHRcdFx0c3RhY2tzOiB7XG5cdFx0XHRcdFx0b25lOiAxLFxuXHRcdFx0XHRcdHR3bzogMixcblx0XHRcdFx0XHR0aHJlZTogMyxcblx0XHRcdFx0fSxcblx0XHRcdH07XG5cdFx0XHRjb25zdCBhY3R1YWwgPSB1bmRlclRlc3QuY3JlYXRlUmVzb3VyY2VzKFxuXHRcdFx0XHRzY29wZSxcblx0XHRcdFx0cHJvcHMsXG5cdFx0XHRcdGFwaSxcblx0XHRcdFx0cHJvdmlkZXJzLFxuXHRcdFx0XHRjZlNjaGVtYSxcblx0XHRcdCk7XG5cdFx0XHRleHBlY3QoYWN0dWFsKS50b0VxdWFsKGV4cGVjdGVkKTtcblx0XHR9KTtcblx0fSk7XG5cdGRlc2NyaWJlKFwiZ2V0Q2ZTY2hlbWFcIiwgKCkgPT4ge1xuXHRcdGl0KFwic2hvdWxkIHR1cm4gdGV4dCBpbnRvIFwiLCAoKSA9PiB7XG5cdFx0XHRjb25zdCBzY2hlbWFUZXh0ID0gXCJzY2hlbWEgdGV4dFwiO1xuXHRcdFx0Y29uc3QgcHJvcHMgPSB7XG5cdFx0XHRcdHByb3AxOiBcInByb3AgMVwiLFxuXHRcdFx0fTtcblx0XHRcdGNvbnN0IHByb3ZpZGVycyA9IFtcblx0XHRcdFx0eyBnZXRUcmFuc2Zvcm1lcjogKCkgPT4gW1wicHJvdmlkZXIgMVwiXSB9LFxuXHRcdFx0XHR7IGdldFRyYW5zZm9ybWVyOiAoKSA9PiBbXCJwcm92aWRlciAyXCJdIH0sXG5cdFx0XHRdO1xuXHRcdFx0Y29uc3QgdHJhbnNmb3JtZXJzID0geyB0cmFuc2Zvcm1lcnM6IFtcInByb3ZpZGVyIDFcIiwgXCJwcm92aWRlciAyXCJdIH07XG5cdFx0XHRjb25zdCBleHBlY3RlZCA9IFwiZXhwZWN0ZWRcIjtcblx0XHRcdGNvbnN0IHsgR3JhcGhRTFRyYW5zZm9ybSB9ID0gamVzdC5yZXF1aXJlTW9jayhcImdyYXBocWwtdHJhbnNmb3JtZXItY29yZVwiKTtcblx0XHRcdGNvbnN0IHRyYW5zZm9ybSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoZXhwZWN0ZWQpO1xuXHRcdFx0R3JhcGhRTFRyYW5zZm9ybS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcblx0XHRcdFx0dHJhbnNmb3JtLFxuXHRcdFx0fSkpO1xuXHRcdFx0bW9jay5nZXRTY2hlbWFUZXh0Lm1vY2tSZXR1cm5WYWx1ZShzY2hlbWFUZXh0KTtcblx0XHRcdGNvbnN0IGFjdHVhbCA9IHVuZGVyVGVzdC5nZXRDZlNjaGVtYShwcm9wcywgcHJvdmlkZXJzKTtcblx0XHRcdGV4cGVjdChhY3R1YWwpLnRvRXF1YWwoZXhwZWN0ZWQpO1xuXHRcdFx0ZXhwZWN0KEdyYXBoUUxUcmFuc2Zvcm0pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHRyYW5zZm9ybWVycyk7XG5cdFx0XHRleHBlY3QodHJhbnNmb3JtKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChzY2hlbWFUZXh0KTtcblx0XHR9KTtcblx0fSk7XG5cdGRlc2NyaWJlKFwiY3JlYXRlQXBpXCIsICgpID0+IHtcblx0XHRpdChcInNob3VsZCBjcmVhdGUgYW4gQ0RLIEdyYXBoUUwgQVBJXCIsICgpID0+IHtcblx0XHRcdGNvbnN0IHsgY3JlYXRlQ29uc3RydWN0IH0gPSBqZXN0LnJlcXVpcmVNb2NrKFwiLi4vdXRpbHNcIik7XG5cdFx0XHRjb25zdCBuYW1lID0gXCJncmFwaHFsLWFwaVwiO1xuXHRcdFx0Y29uc3QgcmVzb3VyY2VOYW1lID0gXCJncmFwaHFsLWFwaVwiO1xuXHRcdFx0Y29uc3Qgc2NvcGUgPSB7IHNjb3BlOiBcInNjb3BlXCIgfTtcblx0XHRcdGNvbnN0IHNjaGVtYSA9IFwic2NoZW1hXCI7XG5cdFx0XHRjb25zdCBwcm9wcyA9IHsgbmFtZSwgc2NoZW1hIH07XG5cdFx0XHRjb25zdCBleHBlY3RlZCA9IFwiZXhwZWN0ZWRcIjtcblx0XHRcdGNyZWF0ZUNvbnN0cnVjdC5tb2NrUmV0dXJuVmFsdWUoZXhwZWN0ZWQpO1xuXHRcdFx0Y29uc3QgYWN0dWFsID0gdW5kZXJUZXN0LmNyZWF0ZUFwaShzY29wZSwgc2NoZW1hKTtcblx0XHRcdGV4cGVjdChhY3R1YWwpLnRvRXF1YWwoZXhwZWN0ZWQpO1xuXHRcdFx0ZXhwZWN0KGNyZWF0ZUNvbnN0cnVjdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG5cdFx0XHRcdHNjb3BlLFxuXHRcdFx0XHRwcm9wcyxcblx0XHRcdFx0R3JhcGhxbEFwaSxcblx0XHRcdFx0XCJncmFwaHFsLWFwaVwiLFxuXHRcdFx0KTtcblx0XHR9KTtcblx0fSk7XG5cblx0ZGVzY3JpYmUoXCJBcHBTeW5jR3FsU2NoZW1hXCIsICgpID0+IHtcblx0XHRpdChcInNob3VsZCBjcmVhdGUgYSBuZXcgY29uc3RydWN0XCIsICgpPT4geyBcblx0XHRcdGNvbnN0IHByb3BzID0ge1xuXHRcdFx0XHRlbnZpcm9ubWVudDoge1xuXHRcdFx0XHRcdEVOVl9WQVIgOiBcImVudiB2YXJcIlxuXHRcdFx0XHR9LFxuXHRcdFx0XHRjb250ZXh0OiBcImNvbnRleHRcIixcblx0XHRcdFx0cHJlZml4OiBcInByZWZpeFwiLFxuXHRcdFx0XHRzY2hlbWFGaWxlOiBcInNjaGVtYUZpbGVcIixcblx0XHRcdFx0c2NoZW1hVGV4dDogXCJzY2hlbWFUZXh0XCIsXG5cdFx0XHRcdGRlZmF1bHRzRGlyZWN0b3J5OiBcInN0cmluZ1wiLFxuXHRcdFx0XHRvdmVycmlkZXNEaXJlY3Rvcnk6IFwic3RyaW5nXCIsXG5cdFx0XHRcdGRlZmF1bHRzOiBcImRlZmF1bHRzXCIsXG5cdFx0XHRcdG92ZXJyaWRlczogXCJvdmVycmlkZXNcIixcblx0XHRcdFx0ZGF0YXNvdXJjZVByb3ZpZGVyczogXCJkYXRhc291cmNlUHJvdmlkZXJzXCJcblx0XHRcdH07XG5cdFx0XHRjb25zdCBzY29wZSA9IG5ldyBBcHAoe30pO1xuXHRcdFx0Y29uc3QgbmFtZSA9IFwicHJvdmlkZXJzXCI7XG5cdFx0XHRjb25zdCBwcm92aWRlcnMgPSBcInByb3ZpZGVyc1wiO1xuXHRcdFx0Y29uc3QgY2ZTY2hlbWEgPSBcImNmU2NoZW1hXCI7XG5cblx0XHRcdG1vY2suZ2V0UHJvdmlkZXJzLm1vY2tSZXR1cm5WYWx1ZShwcm92aWRlcnMpO1xuXHRcdFx0bW9jay5nZXRDZlNjaGVtYS5tb2NrUmV0dXJuVmFsdWUoY2ZTY2hlbWEpO1xuXHRcdFx0Y29uc3QgYWN0dWFsID0gbmV3IHVuZGVyVGVzdC5BcHBTeW5jR3FsU2NoZW1hKHNjb3BlLCBuYW1lLCBwcm9wcyk7XG5cdFx0XHRleHBlY3QobW9jay5nZXRQcm92aWRlcnMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHByb3BzKTtcblx0XHRcdGV4cGVjdChtb2NrLmdldENmU2NoZW1hKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChwcm9wcywgcHJvdmlkZXJzKTtcblx0XHR9KVxuXHR9KVxufSk7XG4iXX0=
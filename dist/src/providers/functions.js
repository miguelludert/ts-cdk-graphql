"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getResponseResolverName = exports.getRequestResolverName = exports.getTypeName = exports.getFieldName = exports.getDataSourceName = exports.createFunctionsFromResource = exports.createPipelineResolversFromResource = exports.createResolversFromResource = exports.createResolversAndFunctionsFromStack = exports.createResolversAndFunctionsFromSchema = void 0;
const aws_appsync_1 = require("@aws-cdk/aws-appsync");
const ramda_1 = require("ramda");
const constants_1 = require("../constants");
const utils_1 = require("./utils");
const self = __importStar(require("./functions"));
const createResolversAndFunctionsFromSchema = (scope, props, api, cfSchema, resources) => {
    utils_1.info("functions.createResolversAndFunctionsFromSchema");
    const stackResources = Object.values(cfSchema.stacks);
    const results = stackResources.map(self.createResolversAndFunctionsFromStack(scope, props, api, cfSchema, resources));
    return results;
};
exports.createResolversAndFunctionsFromSchema = createResolversAndFunctionsFromSchema;
exports.createResolversAndFunctionsFromStack = ramda_1.curry((scope, props, api, cfSchema, datasources, stack) => {
    utils_1.info("functions.createResolversAndFunctionsFromStack");
    const resourcePairs = ramda_1.toPairs(stack.Resources);
    const { [constants_1.RESOURCE_TYPE_RESOLVER]: resolverPairs, [constants_1.RESOURCE_TYPE_FUNCTION_CONFIG]: funcPairs, } = ramda_1.groupBy(([, resource]) => resource.Type, resourcePairs);
    const funcs = ramda_1.map(self.createFunctionsFromResource(scope, props, api, cfSchema, datasources), funcPairs || []);
    const pipelineResolverPairs = ramda_1.filter(([, cfn]) => cfn.Properties.Kind === "PIPELINE", resolverPairs || []);
    const regularResolverPairs = ramda_1.filter(([, cfn]) => cfn.Properties.Kind !== "PIPELINE", resolverPairs || []);
    const resolvers = ramda_1.map(self.createResolversFromResource(scope, props, api, cfSchema, datasources), regularResolverPairs || []);
    const pipelineResolvers = ramda_1.map(self.createPipelineResolversFromResource(scope, props, api, cfSchema, datasources, funcs), pipelineResolverPairs || []);
    return {
        funcs,
        resolvers,
    };
});
exports.createResolversFromResource = ramda_1.curry((scope, props, api, cfSchema, datasources, [resolverName, resolverCfn]) => {
    utils_1.info("functions.createResolversFromResource");
    const datasourceName = exports.getDataSourceName(resolverCfn);
    if (!datasourceName) {
        return;
    }
    const { datasource } = datasources.find((f) => f && f.datasourceName == datasourceName);
    const typeName = self.getTypeName(resolverCfn);
    const fieldName = self.getFieldName(resolverCfn);
    const requestMappingTemplateName = self.getRequestResolverName(resolverCfn);
    const responseMappingTemplateName = self.getResponseResolverName(resolverCfn);
    const resolverProps = {
        fieldName,
        typeName,
        requestMappingTemplate: aws_appsync_1.MappingTemplate.fromString(cfSchema.resolvers[requestMappingTemplateName]),
        responseMappingTemplate: aws_appsync_1.MappingTemplate.fromString(cfSchema.resolvers[responseMappingTemplateName]),
    };
    const resolver = datasource.createResolver(resolverProps);
    return;
    {
        resolverName, resolver, resolverProps, resolverCfn;
    }
});
exports.createPipelineResolversFromResource = ramda_1.curry((scope, props, api, cfSchema, datasources, funcs, [resolverName, resolverCfn]) => {
    utils_1.info("functions.createPipelineResolversFromResource");
    const funcName = resolverCfn.DependsOn;
    const item = funcs.find((f) => f.funcName === funcName);
    const { datasource } = item;
    //const pipelineConfig = [func];
    const typeName = self.getTypeName(resolverCfn);
    const fieldName = self.getFieldName(resolverCfn);
    const requestMappingTemplateName = self.getRequestResolverName(resolverCfn);
    const responseMappingTemplateName = self.getResponseResolverName(resolverCfn);
    const resolverProps = {
        api,
        fieldName,
        typeName,
    };
    // console.info("GIMME", {resolverName, fieldName, typeName, requestMappingTemplateName, responseMappingTemplateName, func : func.constructor, funcName});
    // const resolver = new Resolver(scope, resolverName, resolverProps);
    const resolver = datasource.createResolver(resolverProps);
    return {
        resolverName,
        resolver,
        resolverProps,
        resolverCfn,
    };
});
exports.createFunctionsFromResource = ramda_1.curry((scope, props, api, cfSchema, datasources, [funcName, funcCfn]) => {
    utils_1.info("functions.createFunctionsFromResource", funcCfn);
    const datasourceName = funcCfn.Properties.DataSourceName;
    if (!datasourceName) {
        return;
    }
    const { datasource } = datasources.find((f) => f && f.datasourceName == datasourceName);
    if (!datasource) {
        throw new Error(`Datasource '${datasourceName}' not found`);
    }
    const requestMappingTemplateName = `${funcName}.req.vtl`;
    const responseMappingTemplateName = `${funcName}.res.vtl`;
    const funcProps = {
        name: funcName + "uuuuu",
        description: `${funcName} Lambda Function`,
        requestMappingTemplate: aws_appsync_1.MappingTemplate.fromString(cfSchema.pipelineFunctions[requestMappingTemplateName]),
        responseMappingTemplate: aws_appsync_1.MappingTemplate.fromString(cfSchema.pipelineFunctions[responseMappingTemplateName]),
    };
    //const func = datasource.createFunction(funcProps);
    return {
        datasource,
        datasourceName,
        funcName,
        //func,
        funcProps,
    };
});
exports.getDataSourceName = ramda_1.view(ramda_1.lensPath(["Properties", "DataSourceName", "Fn::GetAtt", 0]));
exports.getFieldName = ramda_1.view(ramda_1.lensPath(["Properties", "FieldName"]));
exports.getTypeName = ramda_1.view(ramda_1.lensPath(["Properties", "TypeName"]));
const getRequestResolverName = (resource) => ramda_1.join(".", ramda_1.view(ramda_1.lensPath([
    "Properties",
    "RequestMappingTemplateS3Location",
    "Fn::Sub",
    1,
    "ResolverFileName",
    "Fn::Join",
    1,
]), resource));
exports.getRequestResolverName = getRequestResolverName;
const getResponseResolverName = (resource) => ramda_1.join(".", ramda_1.view(ramda_1.lensPath([
    "Properties",
    "ResponseMappingTemplateS3Location",
    "Fn::Sub",
    1,
    "ResolverFileName",
    "Fn::Join",
    1,
]), resource));
exports.getResponseResolverName = getResponseResolverName;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3Byb3ZpZGVycy9mdW5jdGlvbnMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHNEQUFpRTtBQUNqRSxpQ0FXZTtBQUNmLDRDQUdzQjtBQUN0QixtQ0FBMkU7QUFDM0Usa0RBQW9DO0FBRTdCLE1BQU0scUNBQXFDLEdBQUcsQ0FDcEQsS0FBSyxFQUNMLEtBQUssRUFDTCxHQUFHLEVBQ0gsUUFBUSxFQUNSLFNBQVMsRUFDUixFQUFFO0lBQ0gsWUFBSSxDQUFDLGlEQUFpRCxDQUFDLENBQUM7SUFDeEQsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEQsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FDakMsSUFBSSxDQUFDLG9DQUFvQyxDQUN4QyxLQUFLLEVBQ0wsS0FBSyxFQUNMLEdBQUcsRUFDSCxRQUFRLEVBQ1IsU0FBUyxDQUNULENBQ0QsQ0FBQztJQUNGLE9BQU8sT0FBTyxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQW5CVyxRQUFBLHFDQUFxQyx5Q0FtQmhEO0FBRVcsUUFBQSxvQ0FBb0MsR0FBRyxhQUFLLENBQ3hELENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsRUFBRTtJQUNuRCxZQUFJLENBQUMsZ0RBQWdELENBQUMsQ0FBQztJQUN2RCxNQUFNLGFBQWEsR0FBRyxlQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQy9DLE1BQU0sRUFDTCxDQUFDLGtDQUFzQixDQUFDLEVBQUUsYUFBYSxFQUN2QyxDQUFDLHlDQUE2QixDQUFDLEVBQUUsU0FBUyxHQUMxQyxHQUFHLGVBQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsRUFBRSxFQUFF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QUFJLENBQUMsZ0JBQVEsQ0FBQyxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDM0QsUUFBQSxXQUFXLEdBQUcsWUFBSSxDQUFDLGdCQUFRLENBQUMsQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQy9ELE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUNsRCxZQUFJLENBQ0gsR0FBRyxFQUNILFlBQUksQ0FDSCxnQkFBUSxDQUFDO0lBQ1IsWUFBWTtJQUNaLGtDQUFrQztJQUNsQyxTQUFTO0lBQ1QsQ0FBQztJQUNELGtCQUFrQjtJQUNsQixVQUFVO0lBQ1YsQ0FBQztDQUNELENBQUMsRUFDRixRQUFRLENBQ1IsQ0FDRCxDQUFDO0FBZlUsUUFBQSxzQkFBc0IsMEJBZWhDO0FBRUksTUFBTSx1QkFBdUIsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQ25ELFlBQUksQ0FDSCxHQUFHLEVBQ0gsWUFBSSxDQUNILGdCQUFRLENBQUM7SUFDUixZQUFZO0lBQ1osbUNBQW1DO0lBQ25DLFNBQVM7SUFDVCxDQUFDO0lBQ0Qsa0JBQWtCO0lBQ2xCLFVBQVU7SUFDVixDQUFDO0NBQ0QsQ0FBQyxFQUNGLFFBQVEsQ0FDUixDQUNELENBQUM7QUFmVSxRQUFBLHVCQUF1QiwyQkFlakMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYXBwaW5nVGVtcGxhdGUsIFJlc29sdmVyIH0gZnJvbSBcIkBhd3MtY2RrL2F3cy1hcHBzeW5jXCI7XG5pbXBvcnQge1xuXHRjdXJyeSxcblx0ZmlsdGVyLFxuXHRncm91cEJ5LFxuXHRqb2luLFxuXHRsZW5zUGF0aCxcblx0bWFwLFxuXHR0b1BhaXJzLFxuXHRwaXBlLFxuXHRwcm9wLFxuXHR2aWV3LFxufSBmcm9tIFwicmFtZGFcIjtcbmltcG9ydCB7XG5cdFJFU09VUkNFX1RZUEVfUkVTT0xWRVIsXG5cdFJFU09VUkNFX1RZUEVfRlVOQ1RJT05fQ09ORklHLFxufSBmcm9tIFwiLi4vY29uc3RhbnRzXCI7XG5pbXBvcnQgeyBjcmVhdGVDb25zdHJ1Y3QsIGZpbHRlclJlc291cmNlUGFpcnNCeVR5cGUsIGluZm8gfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0ICogYXMgc2VsZiBmcm9tIFwiLi9mdW5jdGlvbnNcIjtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZVJlc29sdmVyc0FuZEZ1bmN0aW9uc0Zyb21TY2hlbWEgPSAoXG5cdHNjb3BlLFxuXHRwcm9wcyxcblx0YXBpLFxuXHRjZlNjaGVtYSxcblx0cmVzb3VyY2VzLFxuKSA9PiB7XG5cdGluZm8oXCJmdW5jdGlvbnMuY3JlYXRlUmVzb2x2ZXJzQW5kRnVuY3Rpb25zRnJvbVNjaGVtYVwiKTtcblx0Y29uc3Qgc3RhY2tSZXNvdXJjZXMgPSBPYmplY3QudmFsdWVzKGNmU2NoZW1hLnN0YWNrcyk7XG5cdGNvbnN0IHJlc3VsdHMgPSBzdGFja1Jlc291cmNlcy5tYXAoXG5cdFx0c2VsZi5jcmVhdGVSZXNvbHZlcnNBbmRGdW5jdGlvbnNGcm9tU3RhY2soXG5cdFx0XHRzY29wZSxcblx0XHRcdHByb3BzLFxuXHRcdFx0YXBpLFxuXHRcdFx0Y2ZTY2hlbWEsXG5cdFx0XHRyZXNvdXJjZXMsXG5cdFx0KSxcblx0KTtcblx0cmV0dXJuIHJlc3VsdHM7XG59O1xuXG5leHBvcnQgY29uc3QgY3JlYXRlUmVzb2x2ZXJzQW5kRnVuY3Rpb25zRnJvbVN0YWNrID0gY3VycnkoXG5cdChzY29wZSwgcHJvcHMsIGFwaSwgY2ZTY2hlbWEsIGRhdGFzb3VyY2VzLCBzdGFjaykgPT4ge1xuXHRcdGluZm8oXCJmdW5jdGlvbnMuY3JlYXRlUmVzb2x2ZXJzQW5kRnVuY3Rpb25zRnJvbVN0YWNrXCIpO1xuXHRcdGNvbnN0IHJlc291cmNlUGFpcnMgPSB0b1BhaXJzKHN0YWNrLlJlc291cmNlcyk7XG5cdFx0Y29uc3Qge1xuXHRcdFx0W1JFU09VUkNFX1RZUEVfUkVTT0xWRVJdOiByZXNvbHZlclBhaXJzLFxuXHRcdFx0W1JFU09VUkNFX1RZUEVfRlVOQ1RJT05fQ09ORklHXTogZnVuY1BhaXJzLFxuXHRcdH0gPSBncm91cEJ5KChbLCByZXNvdXJjZV0pID0+IHJlc291cmNlLlR5cGUsIHJlc291cmNlUGFpcnMpO1xuXHRcdGNvbnN0IGZ1bmNzID0gbWFwKFxuXHRcdFx0c2VsZi5jcmVhdGVGdW5jdGlvbnNGcm9tUmVzb3VyY2UoXG5cdFx0XHRcdHNjb3BlLFxuXHRcdFx0XHRwcm9wcyxcblx0XHRcdFx0YXBpLFxuXHRcdFx0XHRjZlNjaGVtYSxcblx0XHRcdFx0ZGF0YXNvdXJjZXMsXG5cdFx0XHQpLFxuXHRcdFx0ZnVuY1BhaXJzIHx8IFtdLFxuXHRcdCk7XG5cdFx0Y29uc3QgcGlwZWxpbmVSZXNvbHZlclBhaXJzID0gZmlsdGVyKFxuXHRcdFx0KFssIGNmbl0pID0+IGNmbi5Qcm9wZXJ0aWVzLktpbmQgPT09IFwiUElQRUxJTkVcIixcblx0XHRcdHJlc29sdmVyUGFpcnMgfHwgW10sXG5cdFx0KTtcblx0XHRjb25zdCByZWd1bGFyUmVzb2x2ZXJQYWlycyA9IGZpbHRlcihcblx0XHRcdChbLCBjZm5dKSA9PiBjZm4uUHJvcGVydGllcy5LaW5kICE9PSBcIlBJUEVMSU5FXCIsXG5cdFx0XHRyZXNvbHZlclBhaXJzIHx8IFtdLFxuXHRcdCk7XG5cdFx0Y29uc3QgcmVzb2x2ZXJzID0gbWFwKFxuXHRcdFx0c2VsZi5jcmVhdGVSZXNvbHZlcnNGcm9tUmVzb3VyY2UoXG5cdFx0XHRcdHNjb3BlLFxuXHRcdFx0XHRwcm9wcyxcblx0XHRcdFx0YXBpLFxuXHRcdFx0XHRjZlNjaGVtYSxcblx0XHRcdFx0ZGF0YXNvdXJjZXMsXG5cdFx0XHQpLFxuXHRcdFx0cmVndWxhclJlc29sdmVyUGFpcnMgfHwgW10sXG5cdFx0KTtcblx0XHRjb25zdCBwaXBlbGluZVJlc29sdmVycyA9IG1hcChcblx0XHRcdHNlbGYuY3JlYXRlUGlwZWxpbmVSZXNvbHZlcnNGcm9tUmVzb3VyY2UoXG5cdFx0XHRcdHNjb3BlLFxuXHRcdFx0XHRwcm9wcyxcblx0XHRcdFx0YXBpLFxuXHRcdFx0XHRjZlNjaGVtYSxcblx0XHRcdFx0ZGF0YXNvdXJjZXMsXG5cdFx0XHRcdGZ1bmNzLFxuXHRcdFx0KSxcblx0XHRcdHBpcGVsaW5lUmVzb2x2ZXJQYWlycyB8fCBbXSxcblx0XHQpO1xuXHRcdHJldHVybiB7XG5cdFx0XHRmdW5jcyxcblx0XHRcdHJlc29sdmVycyxcblx0XHRcdC8vcGlwZWxpbmVSZXNvbHZlcnNcblx0XHR9O1xuXHR9LFxuKTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZVJlc29sdmVyc0Zyb21SZXNvdXJjZSA9IGN1cnJ5KFxuXHQoc2NvcGUsIHByb3BzLCBhcGksIGNmU2NoZW1hLCBkYXRhc291cmNlcywgW3Jlc29sdmVyTmFtZSwgcmVzb2x2ZXJDZm5dKSA9PiB7XG5cdFx0aW5mbyhcImZ1bmN0aW9ucy5jcmVhdGVSZXNvbHZlcnNGcm9tUmVzb3VyY2VcIik7XG5cdFx0Y29uc3QgZGF0YXNvdXJjZU5hbWUgPSBnZXREYXRhU291cmNlTmFtZShyZXNvbHZlckNmbik7XG5cdFx0aWYgKCFkYXRhc291cmNlTmFtZSkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRjb25zdCB7IGRhdGFzb3VyY2UgfSA9IGRhdGFzb3VyY2VzLmZpbmQoXG5cdFx0XHQoZikgPT4gZiAmJiBmLmRhdGFzb3VyY2VOYW1lID09IGRhdGFzb3VyY2VOYW1lLFxuXHRcdCk7XG5cdFx0Y29uc3QgdHlwZU5hbWUgPSBzZWxmLmdldFR5cGVOYW1lKHJlc29sdmVyQ2ZuKTtcblx0XHRjb25zdCBmaWVsZE5hbWUgPSBzZWxmLmdldEZpZWxkTmFtZShyZXNvbHZlckNmbik7XG5cdFx0Y29uc3QgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZU5hbWUgPSBzZWxmLmdldFJlcXVlc3RSZXNvbHZlck5hbWUocmVzb2x2ZXJDZm4pO1xuXHRcdGNvbnN0IHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlTmFtZSA9IHNlbGYuZ2V0UmVzcG9uc2VSZXNvbHZlck5hbWUoXG5cdFx0XHRyZXNvbHZlckNmbixcblx0XHQpO1xuXHRcdGNvbnN0IHJlc29sdmVyUHJvcHMgPSB7XG5cdFx0XHRmaWVsZE5hbWUsXG5cdFx0XHR0eXBlTmFtZSxcblx0XHRcdHJlcXVlc3RNYXBwaW5nVGVtcGxhdGU6IE1hcHBpbmdUZW1wbGF0ZS5mcm9tU3RyaW5nKFxuXHRcdFx0XHRjZlNjaGVtYS5yZXNvbHZlcnNbcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZU5hbWVdLFxuXHRcdFx0KSxcblx0XHRcdHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZnJvbVN0cmluZyhcblx0XHRcdFx0Y2ZTY2hlbWEucmVzb2x2ZXJzW3Jlc3BvbnNlTWFwcGluZ1RlbXBsYXRlTmFtZV0sXG5cdFx0XHQpLFxuXHRcdH07XG5cdFx0Y29uc3QgcmVzb2x2ZXIgPSBkYXRhc291cmNlLmNyZWF0ZVJlc29sdmVyKHJlc29sdmVyUHJvcHMpO1xuXHRcdHJldHVybjtcblx0XHR7XG5cdFx0XHRyZXNvbHZlck5hbWUsIHJlc29sdmVyLCByZXNvbHZlclByb3BzLCByZXNvbHZlckNmbjtcblx0XHR9XG5cdH0sXG4pO1xuXG5leHBvcnQgY29uc3QgY3JlYXRlUGlwZWxpbmVSZXNvbHZlcnNGcm9tUmVzb3VyY2UgPSBjdXJyeShcblx0KFxuXHRcdHNjb3BlLFxuXHRcdHByb3BzLFxuXHRcdGFwaSxcblx0XHRjZlNjaGVtYSxcblx0XHRkYXRhc291cmNlcyxcblx0XHRmdW5jcyxcblx0XHRbcmVzb2x2ZXJOYW1lLCByZXNvbHZlckNmbl0sXG5cdCkgPT4ge1xuXHRcdGluZm8oXCJmdW5jdGlvbnMuY3JlYXRlUGlwZWxpbmVSZXNvbHZlcnNGcm9tUmVzb3VyY2VcIik7XG5cdFx0Y29uc3QgZnVuY05hbWUgPSByZXNvbHZlckNmbi5EZXBlbmRzT247XG5cdFx0Y29uc3QgaXRlbSA9IGZ1bmNzLmZpbmQoKGYpID0+IGYuZnVuY05hbWUgPT09IGZ1bmNOYW1lKTtcblx0XHRjb25zdCB7IGRhdGFzb3VyY2UgfSA9IGl0ZW07XG5cdFx0Ly9jb25zdCBwaXBlbGluZUNvbmZpZyA9IFtmdW5jXTtcblx0XHRjb25zdCB0eXBlTmFtZSA9IHNlbGYuZ2V0VHlwZU5hbWUocmVzb2x2ZXJDZm4pO1xuXHRcdGNvbnN0IGZpZWxkTmFtZSA9IHNlbGYuZ2V0RmllbGROYW1lKHJlc29sdmVyQ2ZuKTtcblx0XHRjb25zdCByZXF1ZXN0TWFwcGluZ1RlbXBsYXRlTmFtZSA9IHNlbGYuZ2V0UmVxdWVzdFJlc29sdmVyTmFtZShyZXNvbHZlckNmbik7XG5cdFx0Y29uc3QgcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGVOYW1lID0gc2VsZi5nZXRSZXNwb25zZVJlc29sdmVyTmFtZShcblx0XHRcdHJlc29sdmVyQ2ZuLFxuXHRcdCk7XG5cdFx0Y29uc3QgcmVzb2x2ZXJQcm9wcyA9IHtcblx0XHRcdGFwaSxcblx0XHRcdGZpZWxkTmFtZSxcblx0XHRcdHR5cGVOYW1lLFxuXHRcdFx0Ly8gcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZTogTWFwcGluZ1RlbXBsYXRlLmZyb21TdHJpbmcoXG5cdFx0XHQvLyBcdGNmU2NoZW1hLnJlc29sdmVyc1tyZXF1ZXN0TWFwcGluZ1RlbXBsYXRlTmFtZV0sXG5cdFx0XHQvLyApLFxuXHRcdFx0Ly8gcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGU6IE1hcHBpbmdUZW1wbGF0ZS5mcm9tU3RyaW5nKFxuXHRcdFx0Ly8gXHRjZlNjaGVtYS5yZXNvbHZlcnNbcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGVOYW1lXSxcblx0XHRcdC8vICksXG5cdFx0XHQvL3BpcGVsaW5lQ29uZmlnLFxuXHRcdH07XG5cdFx0Ly8gY29uc29sZS5pbmZvKFwiR0lNTUVcIiwge3Jlc29sdmVyTmFtZSwgZmllbGROYW1lLCB0eXBlTmFtZSwgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZU5hbWUsIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlTmFtZSwgZnVuYyA6IGZ1bmMuY29uc3RydWN0b3IsIGZ1bmNOYW1lfSk7XG5cdFx0Ly8gY29uc3QgcmVzb2x2ZXIgPSBuZXcgUmVzb2x2ZXIoc2NvcGUsIHJlc29sdmVyTmFtZSwgcmVzb2x2ZXJQcm9wcyk7XG5cblx0XHRjb25zdCByZXNvbHZlciA9IGRhdGFzb3VyY2UuY3JlYXRlUmVzb2x2ZXIocmVzb2x2ZXJQcm9wcyk7XG5cdFx0cmV0dXJuIHtcblx0XHRcdHJlc29sdmVyTmFtZSxcblx0XHRcdHJlc29sdmVyLFxuXHRcdFx0cmVzb2x2ZXJQcm9wcyxcblx0XHRcdHJlc29sdmVyQ2ZuLFxuXHRcdH07XG5cdH0sXG4pO1xuXG5leHBvcnQgY29uc3QgY3JlYXRlRnVuY3Rpb25zRnJvbVJlc291cmNlID0gY3VycnkoXG5cdChzY29wZSwgcHJvcHMsIGFwaSwgY2ZTY2hlbWEsIGRhdGFzb3VyY2VzLCBbZnVuY05hbWUsIGZ1bmNDZm5dKSA9PiB7XG5cdFx0aW5mbyhcImZ1bmN0aW9ucy5jcmVhdGVGdW5jdGlvbnNGcm9tUmVzb3VyY2VcIiwgZnVuY0Nmbik7XG5cblx0XHRjb25zdCBkYXRhc291cmNlTmFtZSA9IGZ1bmNDZm4uUHJvcGVydGllcy5EYXRhU291cmNlTmFtZTtcblx0XHRpZiAoIWRhdGFzb3VyY2VOYW1lKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGNvbnN0IHsgZGF0YXNvdXJjZSB9ID0gZGF0YXNvdXJjZXMuZmluZChcblx0XHRcdChmKSA9PiBmICYmIGYuZGF0YXNvdXJjZU5hbWUgPT0gZGF0YXNvdXJjZU5hbWUsXG5cdFx0KTtcblx0XHRpZiAoIWRhdGFzb3VyY2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgRGF0YXNvdXJjZSAnJHtkYXRhc291cmNlTmFtZX0nIG5vdCBmb3VuZGApO1xuXHRcdH1cblx0XHRjb25zdCByZXF1ZXN0TWFwcGluZ1RlbXBsYXRlTmFtZSA9IGAke2Z1bmNOYW1lfS5yZXEudnRsYDtcblx0XHRjb25zdCByZXNwb25zZU1hcHBpbmdUZW1wbGF0ZU5hbWUgPSBgJHtmdW5jTmFtZX0ucmVzLnZ0bGA7XG5cdFx0Y29uc3QgZnVuY1Byb3BzID0ge1xuXHRcdFx0bmFtZTogZnVuY05hbWUgKyBcInV1dXV1XCIsXG5cdFx0XHRkZXNjcmlwdGlvbjogYCR7ZnVuY05hbWV9IExhbWJkYSBGdW5jdGlvbmAsXG5cdFx0XHRyZXF1ZXN0TWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZnJvbVN0cmluZyhcblx0XHRcdFx0Y2ZTY2hlbWEucGlwZWxpbmVGdW5jdGlvbnNbcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZU5hbWVdLFxuXHRcdFx0KSxcblx0XHRcdHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZnJvbVN0cmluZyhcblx0XHRcdFx0Y2ZTY2hlbWEucGlwZWxpbmVGdW5jdGlvbnNbcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGVOYW1lXSxcblx0XHRcdCksXG5cdFx0fTtcblx0XHQvL2NvbnN0IGZ1bmMgPSBkYXRhc291cmNlLmNyZWF0ZUZ1bmN0aW9uKGZ1bmNQcm9wcyk7XG5cdFx0cmV0dXJuIHtcblx0XHRcdGRhdGFzb3VyY2UsXG5cdFx0XHRkYXRhc291cmNlTmFtZSxcblx0XHRcdGZ1bmNOYW1lLFxuXHRcdFx0Ly9mdW5jLFxuXHRcdFx0ZnVuY1Byb3BzLFxuXHRcdH07XG5cdH0sXG4pO1xuXG5leHBvcnQgY29uc3QgZ2V0RGF0YVNvdXJjZU5hbWUgPSB2aWV3KFxuXHRsZW5zUGF0aChbXCJQcm9wZXJ0aWVzXCIsIFwiRGF0YVNvdXJjZU5hbWVcIiwgXCJGbjo6R2V0QXR0XCIsIDBdKSxcbik7XG5leHBvcnQgY29uc3QgZ2V0RmllbGROYW1lID0gdmlldyhsZW5zUGF0aChbXCJQcm9wZXJ0aWVzXCIsIFwiRmllbGROYW1lXCJdKSk7XG5leHBvcnQgY29uc3QgZ2V0VHlwZU5hbWUgPSB2aWV3KGxlbnNQYXRoKFtcIlByb3BlcnRpZXNcIiwgXCJUeXBlTmFtZVwiXSkpO1xuZXhwb3J0IGNvbnN0IGdldFJlcXVlc3RSZXNvbHZlck5hbWUgPSAocmVzb3VyY2UpID0+XG5cdGpvaW4oXG5cdFx0XCIuXCIsXG5cdFx0dmlldyhcblx0XHRcdGxlbnNQYXRoKFtcblx0XHRcdFx0XCJQcm9wZXJ0aWVzXCIsXG5cdFx0XHRcdFwiUmVxdWVzdE1hcHBpbmdUZW1wbGF0ZVMzTG9jYXRpb25cIixcblx0XHRcdFx0XCJGbjo6U3ViXCIsXG5cdFx0XHRcdDEsXG5cdFx0XHRcdFwiUmVzb2x2ZXJGaWxlTmFtZVwiLFxuXHRcdFx0XHRcIkZuOjpKb2luXCIsXG5cdFx0XHRcdDEsXG5cdFx0XHRdKSxcblx0XHRcdHJlc291cmNlLFxuXHRcdCksXG5cdCk7XG5cbmV4cG9ydCBjb25zdCBnZXRSZXNwb25zZVJlc29sdmVyTmFtZSA9IChyZXNvdXJjZSkgPT5cblx0am9pbihcblx0XHRcIi5cIixcblx0XHR2aWV3KFxuXHRcdFx0bGVuc1BhdGgoW1xuXHRcdFx0XHRcIlByb3BlcnRpZXNcIixcblx0XHRcdFx0XCJSZXNwb25zZU1hcHBpbmdUZW1wbGF0ZVMzTG9jYXRpb25cIixcblx0XHRcdFx0XCJGbjo6U3ViXCIsXG5cdFx0XHRcdDEsXG5cdFx0XHRcdFwiUmVzb2x2ZXJGaWxlTmFtZVwiLFxuXHRcdFx0XHRcIkZuOjpKb2luXCIsXG5cdFx0XHRcdDEsXG5cdFx0XHRdKSxcblx0XHRcdHJlc291cmNlLFxuXHRcdCksXG5cdCk7XG4iXX0=